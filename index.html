<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="UTF-8">
	<title>Bibliothèque Multijoueur - HAI305I</title>
	<style>
		body { margin:0; font-family: Arial, sans-serif; }
		#login, #jeu { width:100vw; height:100vh; display:flex; }
		#login { background:#333; color:white; align-items:center; justify-content:center; flex-direction:column; }
		input, button { padding:10px; margin:10px; font-size:1.1em; }
		button { background:#3498db; color:white; border:none; cursor:pointer; }

		#infos { position:fixed; top:0; left:0; right:0; background:#444; color:white; padding:10px 20px; z-index:10; display:flex; justify-content:space-between; }
		#main-container { display:flex; width:100%; height:100%; padding-top:40px; }
		#plateau { flex:1; display:flex; justify-content:center; align-items:center; position:relative; }

		#chat-panel { width:400px; height: 700px; background:#f0f0f0; border-left:1px solid #ccc; display:flex; flex-direction:column; margin-top: 25px ;margin-right:50px; }
		#chat-header { background:#ddd; padding:10px; font-weight:bold; }
		#chat { flex:1; overflow-y:auto; padding:10px; }
		#chat .message { margin-bottom:5px; }
		#chat .message .nom { font-weight:bold; color:#333; }
		#chat .message.system { background:#e9f7ef; border-left:3px solid #2ecc71; padding-left:5px; }
		#chat-input { width:90%; padding:10px; border:2px solid #777 ; box-sizing:border-box; }

		svg { background:#fff; border:1px solid #333; }
		.livre { cursor: move; }
		.tapis { fill: #8B4513; }
		.etagere-line { stroke: #333; stroke-width: 2; }
		.etagere-bg { fill: #ecf0f1; opacity: 0.1; } 

		#InfoL {
		    position: absolute; background: black; color: white; padding: 5px; border-radius: 3px;
		    pointer-events: none; opacity: 0; z-index: 1000;
		}
		#InfoL.visible { opacity: 1; }

		.error-msg, .success-msg { 
		    position:fixed; top:60px; left:50%; 
		    padding:10px 20px; border-radius:5px; z-index:100;
		}
		.error-msg { background:#e74c3c; color:white; }
		.success-msg { background:#2ecc71; color:white; }

		#modal-fin { 
		    display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
		    background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center; 
		}
		#modal-fin.visible { display:flex; }
		#modal-contenu { background:white; padding:30px; border-radius:5px; text-align:center; }
</style>
</head>
<body>
  <div id="login">
	<h1> Bibliothèque Multijoueur</h1>
	<input type="text" id="nom" placeholder="Ton pseudo" maxlength="15">
	<button id="btn-login">Jouer</button>
  </div>

  <div id="jeu" style="display:none;">
	<div id="infos">
		<div>Joueur: <span id="monNom"></span></div>
		<div>Score: <span id="monScore">0</span></div>
		<div>Livres: <span id="compteurLivres">0/30</span></div>
	</div>
	
	<div id="main-container">
		<div id="plateau">
			<div id="InfoL"></div>
		</div>
		
		<div id="chat-panel">
			<div id="chat-header"> Chat</div>
			<div id="chat"></div>
			<div id="chat-input-div">
				<input type="text" id="chat-input" placeholder="Message...">
			</div>
		</div>
	</div>
  </div>

  <div id="modal-fin">
	<div id="modal-contenu">
		<h2 id="modal-titre">Partie terminée</h2>
		<p id="modal-message"></p>
		<button id="btn-rejouer">Rejouer</button>
	</div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <script>
	// ====================== VARIABLES GLOBALES ======================
	const socket = io();
	const loginDiv = document.getElementById('login');
	const jeuDiv = document.getElementById('jeu');
	const nomInput = document.getElementById('nom');
	const btnLogin = document.getElementById('btn-login');
	const chatDiv = document.getElementById('chat');
	const chatInput = document.getElementById('chat-input');
	const modalFin = document.getElementById('modal-fin');
	const InfoL = document.getElementById('InfoL');
	let monNom = '';
	let svg = null;
	let etageres = [[], [], [], [], []]; 
	const LARGEUR = 900;
	const HAUTEUR = 600;
	const MARGE = 80;
	let livresDistribues = 0;
	const MAX_LIVRES = 30;

	// ====================== PHASE 1: CONNEXION ======================
	btnLogin.onclick = () => {
		const nom = nomInput.value.trim();
		if (nom) socket.emit('entree', nom);
	};
	nomInput.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') btnLogin.click();
	});

	// Entrée validée
	socket.on('entree-validee', (data) => {
		monNom = data.nom;
		document.getElementById('monNom').textContent = monNom;
		loginDiv.style.display = 'none';
		jeuDiv.style.display = 'flex';
		initialiserPlateau();
		ajouterMessageChat('Système', "Bienvenue ! En attente d'un autre joueur...", true);
	});
	socket.on('erreur-entree', (msg) => afficherErreur(msg));
	socket.on('joueurs-maj', (data) => {
		if (data.nbJoueurs === 2) {
			console.log('Deux joueurs conectés.');
		}
	});

	// ====================== FASES DE JUEGO ======================
	socket.on('partie-demarre', (data) => {
		ajouterMessageChat('Système', data.message, true);
		afficherSucces('La partie commence ! Bonne chance !');
	});
	
	socket.on('nouveau-livre', (livre) => {
		livresDistribues++;
		const compteur = document.getElementById('compteurLivres');
		compteur.textContent = `${livresDistribues}/${MAX_LIVRES}`;
		if (svg) {
			ajouterLivreAuTapis(livre);
		}
	});

	socket.on('livre-retire', (data) => {
		svg.selectAll('.tapis-livres .livre')
			.filter(d => d && d.id === data.livreId)
			.transition().duration(500).style('opacity', 0).remove();
	});

	socket.on('livre-place', (data) => {
		etageres = data.etageres;
		if (data.joueur === monNom) {
			document.getElementById('monScore').textContent = data.nouveauScore;
			if (data.pointsGagnes > 0) {
				afficherSucces(`+${data.pointsGagnes} points !`);
			}
		}
		
		svg.selectAll('.tapis-livres .livre')
			.filter(d => d && d.id === data.livre.id)
			.remove();
		
		redessinerEtagere(data.etagereIndex);
	});

	// ====================== FIN DE PARTIE ======================
	socket.on('partie-terminee', (data) => {
		document.getElementById('modal-titre').textContent = data.gagnant ? ' Victoire !' : 'Partie terminée';
		let message = data.message;
		if (data.gagnant && data.gagnant === monNom) {
			message = `Félicitations ! Vous avez gagné avec ${data.scoreGagnant} points !`;
		} else if (data.gagnant) {
			message = `${data.gagnant} gagne avec ${data.scoreGagnant} points contre ${data.scorePerdant}.`;
		}
		document.getElementById('modal-message').textContent = message;
		modalFin.classList.add('visible');
		ajouterMessageChat('Système', data.message, true);
	});

	document.getElementById('btn-rejouer').onclick = () => window.location.reload();

	// ====================== CHAT ======================
	socket.on('message', (data) => ajouterMessageChat(data.nom, data.message));

	chatInput.addEventListener('keypress', (e) => {
		if (e.key === 'Enter' && e.target.value.trim()) {
			socket.emit('message', e.target.value.trim());
			e.target.value = '';
		}
	});
	
	// ====================== ERREURS ======================
	socket.on('erreur', (msg) => afficherErreur(msg));

	// ====================== INITIALISATION DU PLATEAU D3 ======================
	function initialiserPlateau() {
		svg = d3.select('#plateau').append('svg')
			.attr('width', LARGEUR).attr('height', HAUTEUR);
		svg.append('rect')
		   .attr('class', 'tapis').attr('x', MARGE).attr('y', HAUTEUR - MARGE - 20)
		   .attr('width', LARGEUR - 2*MARGE).attr('height', 60).attr('rx', 10).attr('ry', 10)
		   .attr('stroke', 'black').attr('stroke-width', 2);
		svg.append('g').attr('class', 'tapis-livres');

		const nbEtageres = 5;
		const espaceEtagere = (HAUTEUR - 2*MARGE - 100) / nbEtageres;

		for (let i = 0; i < nbEtageres; i++) {
			const yEtagere = MARGE + i * espaceEtagere;
			svg.append('rect')
				.attr('class', 'etagere-bg').attr('x', MARGE).attr('y', yEtagere - 5)
				.attr('width', LARGEUR - 2*MARGE).attr('height', 70);
			svg.append('line')
			   .attr('class', 'etagere-line').attr('x1', MARGE).attr('y1', yEtagere + 60)
			   .attr('x2', LARGEUR - MARGE).attr('y2', yEtagere + 60);
			svg.append('text')
				.attr('x', MARGE - 15).attr('y', yEtagere + 35).attr('text-anchor', 'end')
				.style('fill', '#333').style('font-weight', 'bold').text(`${i+1}`);
			svg.append('g')
				.attr('class', `etagere-livres-${i}`).attr('data-etagere', i);
		}
	}

	// ====================== AJOUTER LIVRE AU TAPIS ======================
	function ajouterLivreAuTapis(livre) {
		const groupeTapis = svg.select('.tapis-livres');
		const xDepart = MARGE;
		const yPos = HAUTEUR - MARGE + 5;
		const xArrivee = LARGEUR - MARGE - 85 - Math.random() * (LARGEUR/2 - 100);  

		const livreSVG = dessinerLivre(groupeTapis, livre, xDepart, yPos);
		
		livreSVG.call(drag);
		
		livreSVG.transition()
			.duration(8000)
			.ease(d3.easeCubicOut)
			.attr('transform', `translate(${xArrivee},${yPos})`);

	}
	// ====================== DESSINER UN LIVRE ======================
	function dessinerLivre(groupe, livre, x, y) {
		const formats = { poche: 35, medium: 45, grand: 55, maxi: 65 };
		const h = formats[livre.format] || 45;
		const couleurs = { roman: 'DodgerBlue', sf: 'DarkOrchid', policier: 'Chocolate', théâtre: 'Coral', aventures: 'LightSeaGreen', poésie: 'Orange', thriller: 'Brown', feelgood: 'MediumAquaMarine', essai: 'Darkgrey', fantasy: 'DarkViolet', humour: 'Gold' };
		const couleur = couleurs[livre.genre] || 'Grey';

		const g = groupe.append('g')
			.datum(livre).attr('transform', `translate(${x},${y})`).attr('class', 'livre');

		g.append('rect')
			.attr('width', 85).attr('height', h).attr('fill', couleur).attr('stroke', '#2c3e50').attr('stroke-width', 2);

		g.append('text')
			.attr('x', 42.5).attr('y', h/2 - 3).attr('text-anchor', 'middle').style('font-size', '10px').style('fill', 'white').style('font-weight', 'bold').style('pointer-events', 'none')
			.text(livre.nom || livre.auteur.substring(0, 10));

		g.append('text')
			.attr('x', 42.5).attr('y', h/2 + 10).attr('text-anchor', 'middle').style('font-size', '8px').style('fill', 'white').style('pointer-events', 'none')
			.text(livre.genre);
		
		g.on('mouseover', (event, d) => { afficherInfoL(event, d); })
		 .on('mousemove', (event) => { deplacerInfoL(event); })
		 .on('mouseout', cacherInfoL);
		
		return g;
	}

	// ====================== INFO DES LIVRES ======================
	function afficherInfoL(event, livre) {
		const html = `<div class="titre">${livre.titre}</div><div class="info"> AUTEUR: ${livre.auteur}</div><div class="info"> GENRE: ${livre.genre}</div><div class="info"> FORMAT: ${livre.format}</div>${livre.littérature ? `<div class="info"> LITTERATURE: ${livre.littérature}</div>` : ''}`;
		InfoL.innerHTML = html;
		InfoL.classList.add('visible');
		deplacerInfoL(event);
	}
	function deplacerInfoL(event) {
		const plateauRect = document.getElementById('plateau').getBoundingClientRect();
		InfoL.style.left = (event.pageX - plateauRect.left + 15) + 'px';
		InfoL.style.top = (event.pageY - plateauRect.top + 15) + 'px';
	}
	function cacherInfoL() {
		InfoL.classList.remove('visible');
	}

	// ====================== DRAG & DROP ======================
	const drag = d3.drag()
		.on('start', function(event, d) {

			d3.select(this).interrupt();

			d3.select(this).raise().classed('dragging', true);
			cacherInfoL();
		})
		.on('drag', function(event, d) {
			d3.select(this).attr('transform', `translate(${event.x}, ${event.y})`);
		})
		.on('end', function(event, d) {
			d3.select(this).classed('dragging', false);
			const etagereIndex = detecterEtagere(event.y);
			
			if (etagereIndex !== -1) {
				const position = calculerPosition(event.x, etagereIndex);
				socket.emit('placer-livre', {
					livreId: d.id,
					etagereIndex: etagereIndex,
					position: position
				});
			} else {
				afficherErreur('Dépose le livre sur une étagère !');
				const xOriginal = LARGEUR / 2 - 42.5;
				const yOriginal = HAUTEUR - MARGE + 5;
				d3.select(this).transition().duration(300).attr('transform', `translate(${xOriginal},${yOriginal})`);
			}
		});

	// ====================== LOGIQUE DE DÉPÔT ======================
	function detecterEtagere(y) {
		const espaceEtagere = (HAUTEUR - 2*MARGE - 100) / 5;
		for (let i = 0; i < 5; i++) {
			const yEtagere = MARGE + i * espaceEtagere;
			if (y >= yEtagere - 10 && y <= yEtagere + 70) return i;
		}
		return -1;
	}

	function calculerPosition(x, etagereIndex) {
		const nbLivres = etageres[etagereIndex].length;
		const largeurLivre = 90;
		for (let i = 0; i <= nbLivres; i++) {
			const xPosition = MARGE + 10 + i * largeurLivre;
			if (x < xPosition + largeurLivre / 2) return i;
		}
		return nbLivres;
	}

	function redessinerEtagere(etagereIndex) {
		const groupeEtagere = svg.select(`.etagere-livres-${etagereIndex}`);
		groupeEtagere.selectAll('*').remove();
		const espaceEtagere = (HAUTEUR - 2*MARGE - 100) / 5;
		const yEtagere = MARGE + etagereIndex * espaceEtagere;
		
		etageres[etagereIndex].forEach((livre, idx) => {
			const livreSVG = dessinerLivre(groupeEtagere, livre, MARGE + 10 + idx * 90, yEtagere);
			livreSVG.style('cursor', 'default');
		});
	}

	// ====================== FONCTIONS AUXILIAIRE ======================
	function ajouterMessageChat(nom, message, isSystem = false) {
		const msgDiv = document.createElement('div');
		msgDiv.className = isSystem ? 'message system' : 'message';
		msgDiv.innerHTML = `<span class="nom">${nom}:</span> ${message}`;
		chatDiv.appendChild(msgDiv);
		chatDiv.scrollTop = chatDiv.scrollHeight;
	}

	function afficherErreur(texte) {
		const errorDiv = document.createElement('div');
		errorDiv.className = 'error-msg';
		errorDiv.textContent = texte;
		document.body.appendChild(errorDiv);
		setTimeout(() => errorDiv.remove(), 3000);
	}

	function afficherSucces(texte) {
		const successDiv = document.createElement('div');
		successDiv.className = 'success-msg';
		successDiv.textContent = texte;
		document.body.appendChild(successDiv);
		setTimeout(() => successDiv.remove(), 2000);
	}
	
  </script>
</body>
</html>
